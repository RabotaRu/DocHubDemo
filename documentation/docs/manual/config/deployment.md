# Развертывание

DocHub поддерживает следующие режима развертывания:

1. **Plugin** - Плагин IDE (Idea / VSCode). Вся бизнес-логика располагается в плагине;
2. **Server Less** - Портал. Вся бизнес-логика располагается на клиенте.
2. **Client-Server** - Портал. Основная бизнес-логика располагается на сервере. 

Режима имеют свои преимущества и недостатки. Необходимо их рассмотреть детально:

## Plugin

Самый простой режим. 

Установите плагин из магазина приложений [intellij idea](https://plugins.jetbrains.com/plugin/18518-dochub-architecture-as-code). 
Следуйте подсказкам плагина.

Вам также поможет статья ["Архитектура рядом с кодом"](https://habr.com/ru/post/659595/).

### Преимущества
1. Развертывание буквально за 2 минуты;
2. Встраивание в инструмент производства (IDE);
3. Интерактивное отображение воздействия на код архитектуры;
4. Разметка кода проекта на объекты архитектурного учета и интерактивное взаимодействие с разметкой;
5. Полноценная функциональность.

### Недостатки
1. Монопольный режим, актуальный для развития (внесения изменений) в код архитектуры.

### Рекомендации

Прекрасно подходит для изучения инструмента. 

Остается востребованным на всех этапах внедрения DocHub в организации, т.к. позволяет внедрить подход "Архитектура как код" 
в ключевой этап производства - разработку кодовой базы приложений, сервисов и инфраструктуры. 


## Server Less

[Проект](https://github.com/RabotaRu/DocHub) собирается как обычный статический сайт командой:

```
  npm run build
```

В папку ./dist генерируется комплект файлов, который является DocHub WEB-приложением. 
Подробнее о сборке и развертывании смотри [здесь](https://github.com/RabotaRu/DocHub). 

Файлы содержащие код архитектуры загружаются по доступным приложению URL при его исполнении в браузере.

Проще говоря, если вы развернули сайт на http://www.dochub.local, необходимо указать в переменной окружения корневой манифест,
например:

```
VUE_APP_DOCHUB_ROOT_MANIFEST=workspace/service/root.yaml
```

в этом случае, сразу после загрузки приложения в браузере, DocHub попытается загрузить файл http://www.dochub.local/workspace/service/root.yaml 
и "выполнить" его. В корневом манифесте могут содержаться указания по подключению зависимостей. Например:

```yaml
imports:
  - docs/root.yaml
  - rules/root.yaml
  - plugins/root.yaml
...
```

Эти файлы также будут загружены.

Базовым URL для них будет URL файла "workspace/service/root.yaml". 
Например, для "docs/root.yaml" прямой URL будет - http://www.dochub.local/workspace/service/docs/root.yaml

Подключаемые файлы также могут содержать команды подключения других файлов. В таком случае цикл повторяется.

Таким образом **на клиенте** собирается полная кодовая база архитектуры. 

Вся бизнес-логика выполняется на клиенте.

### Преимущества
1. Минимальное количество серверных ресурсов;
2. Минимальное время на разворачивание и конфигурирование (почти все параметры можно оставить по умолчанию);
3. При интеграции с GitLab позволяет разделять доступы пользователей на уровне репозиториев.

### Недостатки
1. При росте кодовой базы возникает заметная деградация производительности клиентского приложения;
2. Не позволяет разделять доступ пользователей на уровне объектов архитектурного учета;
3. Не предлагает специального интерфейса интеграции (API), что затрудняет переиспользование архитектурных объектов 
   для производственных нужд. 

### Рекомендации

Данный режим оптимален для изучения инструмента и опытной эксплуатации. С ростом кодовой базы и потребностей,
рекомендуется мигрировать в режим "Client-Server".


## Client-Server

В этом режиме основная бизнес-логика DocHub исполняется на сервере. К ней относится (но не ограничивается):

1. Загрузка и сборка кодовой базы архитектуры;
2. Выполнение JSONata запросов к данным архитектуры;
3. Кэширование результатов выполнения JSONata запросов;
4. Контроль доступа к архитектурным артефактам (файлы различного назначения) (в разработке);
5. Разграничение прав доступа к объектам архитектурного учета (в разработке).

Отельно необходимо отметить, что сервер DocHub предоставляет API:

1. **/core/storage/jsonata/:query** - Доступ к кодовой базе (архитектурному Data Lake) через JSONata запросы;
2. **/core/storage/validators/** - Доступ к результату работы [валидаторов](/docs/dochub.rules.validators);
2. **/entities/:entity/presentations/:presentation*** - Доступ к презентациям [сущностей](/docs/dochub.entities) специального типа "upload".

Простейшей сборкой DocHub в режиме Client-Server является команда:

```
  npm run backend
```

При ее выполнении будет собран frontend и запущен backend процесс nodejs в соответствии с конфигурацией среды (см.
[example.env](https://github.com/RabotaRu/DocHub/blob/master/example.env)).

### Преимущества
1. Заметно ускоряет работу пользовательского приложения за счет единоразовой подготовки архитектурной кодовой базы на стороне backend;
2. Позволяет кэшировать результаты запросов и разделять кэши между пользователями, что значительно сокращает отклик приложения на действия пользователя;
3. Позволяет регулировать доступ пользователя к объектам архитектурного учета (в разработке);
4. Скрывает для пользователя чувствительные конфигурационные денные интеграций, например с хранилищами GitLab;
5. Предоставляет API для встраивания DocHub в DevOps процессы.

### Недостатки
1. Требует более сложной конфигурации как самого DocHub так и серверных ресурсов для стабильного функционирования;
2. При сложных связях архитектурного кода, могут потребоваться специальные меры по инвалидации кэша (регулярно чистить кэш);
3. Перезапуск сервера, при значительных объемах кодовой базы может занимать заметное время, что воздействует на всех пользователей.


### Рекомендации

Данный режим разумно использовать при существенных объемах кодовой базы и использовании DocHub как инструмента
встраиваемого в процессы производства (в DevOps процессы в частности). 


## Файлы переменных среды исполнения

Файлы конфигурации среды исполнения:
```text
.env                # загружается во всех случаях
.env.local          # загружается во всех случаях, игнорируется git
.env.[mode]         # загружается только в указанном режиме работы
.env.[mode].local   # загружается только в указанном режиме работы, игнорируется git
```
[Больше информации](https://cli.vuejs.org/ru/guide/mode-and-env.html) 

## Переменные среды исполнения

Актуальные параметры конфигурирования смотрите в файле
[example.env](https://github.com/RabotaRu/DocHub/blob/master/example.env)
